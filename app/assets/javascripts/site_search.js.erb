jQuery(document).ready(function($) {

  if ( $('#full-search').length ) {
    if (!$('#q').val().length) $('#q').focus();

    // Load more results async
    $('#load-more-search-results a').on("click", function(event) {
      event.preventDefault();
      $.get($('#load-more-search-results a').attr("href"), function(data) {
        $('#load-more-search-results').replaceWith(data);
      });
      $(this).text("Laddar fler...").addClass('disabled');
    });
  }

  // Autocomplete
  var $searchField = $('#full-search #q');
  if ( $searchField.length ) {
    $searchField.autocomplete({
      source: function(request, response) {
        $.ajax({
          url: $searchField.attr("data-autocomplete-path"),
          data: {
            q: request.term,
            ilang: 'sv'
          },
          dataType: "jsonp",
          jsonpCallback: "results",
          success: function(data) {
            if (data.length) {
              response($.map(data, function(item) {
                return {
                  hits: item.nHits,
                  suggestionHighlighted: item.suggestionHighlighted,
                  value: item.suggestion
                };
              }));
            }
          }
        });
      },
      minLength: 1,
      select: function(event, ui) {
        document.location = $("#full-search").attr('action') + '?q=' + unescape(ui.item.value);
      },
      open: function(event, ui) {
        $searchField.autocomplete("widget").css('width','282px');
      }
    })
    .data( "autocomplete" )._renderItem = function( ul, item ) {
      return $( "<li></li>" )
      .data( "item.autocomplete", item )
      .append( "<a><span class='hits'>" + item.hits + "</span>" + item.suggestionHighlighted + "</a>" )
      .appendTo( ul );
    };
  }

  // Event tracking of details for selected link in the search results
  if ( $("section.site-search").length ) {
    // Function defined in Assets 3.0
    $('section.site-search h2 a, section.site-search .ess-bestbets a, section.site-search ul.breadcrumb a, section.site-search-categories a').click(function(event) {
      var $a = $(this);
      if (typeof(gaDelayEvent) == "function") gaDelayEvent($a, event);
      var link = $a.attr('href');
      var GAAction = $("#q").val();
      var GALabel = $.trim($a.text()) + " " + link;

      // Track all clicks in the results list
      _gaq.push(['_trackEvent', 'SearchClickPosition', GAAction, GALabel, parseInt($a.closest('li').attr('data-position'), 10)]);

      // Track clicks on breadcrumbs in the results list
      if ($a.closest(".breadcrumb").length > 0) {
        _gaq.push(['_trackEvent', 'SearchClickBreadcrumb', GAAction,  GALabel]);
      }
      // Track clicks on editors choich in the results list
      if ($a.closest(".editors_choice").length > 0) {
        _gaq.push(['_trackEvent', 'SearchClickEditorsChoice', GAAction,  GALabel]);
      }

      // Track clicks on editors choich in the results list
      if ($a.closest(".site-search-categories").length > 0) {
        _gaq.push(['_trackEvent', 'SearchClickCategory', GAAction,  GALabel]);
      }
    });
  }
});
